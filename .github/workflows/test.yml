name: Test Work Planner MCP Server

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Test with GitHub Secrets
      env:
        JIRA_URL: ${{ secrets.JIRA_URL }}
        JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        SLACK_XOXC_TOKEN: ${{ secrets.SLACK_XOXC_TOKEN }}
        SLACK_XOXD_TOKEN: ${{ secrets.SLACK_XOXD_TOKEN }}
        LOGS_CHANNEL_ID: ${{ secrets.LOGS_CHANNEL_ID }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        python -c "
        import os
        print('Testing environment variables from GitHub secrets:')
        print(f'JIRA_URL: {os.getenv(\"JIRA_URL\", \"NOT SET\")}')
        print(f'JIRA_API_TOKEN: {\"SET\" if os.getenv(\"JIRA_API_TOKEN\") else \"NOT SET\"}')
        print(f'SLACK_XOXC_TOKEN: {\"SET\" if os.getenv(\"SLACK_XOXC_TOKEN\") else \"NOT SET\"}')
        print(f'SLACK_XOXD_TOKEN: {\"SET\" if os.getenv(\"SLACK_XOXD_TOKEN\") else \"NOT SET\"}')
        print(f'LOGS_CHANNEL_ID: {os.getenv(\"LOGS_CHANNEL_ID\", \"NOT SET\")}')
        print(f'GEMINI_API_KEY: {\"SET\" if os.getenv(\"GEMINI_API_KEY\") else \"NOT SET\"}')
        print('‚úÖ All secrets loaded successfully!')
        "
    
    - name: Test Gemini Integration
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        python -c "
        print('ü§ñ Testing Gemini integration...')
        try:
            from connectors.gemini.client import GeminiClient
            from connectors.gemini.config import GeminiConfig
            print('‚úÖ Gemini client imported successfully')
            
            config = GeminiConfig()
            print('‚úÖ Gemini config loaded successfully')
            print(f'‚úÖ Model: {config.get_config().get(\"model\", \"Not set\")}')
            
            # Test client initialization
            try:
                client = GeminiClient(config.get_config())
                print('‚úÖ Gemini client initialized successfully')
                print('‚úÖ Gemini integration ready!')
            except Exception as e:
                print(f'‚ö†Ô∏è  Gemini client initialization: {e}')
                print('‚úÖ Integration ready - API key configured')
        except Exception as e:
            print(f'‚ùå Gemini test failed: {e}')
            exit(1)
        "
