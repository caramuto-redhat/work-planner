# MCP Query Filters Configuration

## Overview

The work-planner MCP server now supports **centralized query filtering** through the `mcp_query_filters` section in `config/jira.yaml`. This provides a single configuration point for all MCP tools to customize their default JQL query behavior.

## Configuration Location

File: `config/jira.yaml`

Section: `mcp_query_filters`

## Configuration Options

```yaml
mcp_query_filters:
  # Default status filter for MCP tools
  # Used when no status parameter is provided to MCP tool calls
  default_status: "In Progress"
  
  # List of statuses to include when using "All" filters
  # Used by tools like dump_jira_team_data with "All In Progress" filter
  all_statuses:
    - "To Do"
    - "In Progress"
    - "In Review"
    - "Blocked"
    - "Code Review"
  
  # Default sort order for MCP queries
  order_by: "updated DESC"
  
  # Additional JQL filter to apply to all MCP queries
  # Leave empty for no additional filtering
  additional_jql: ''
  
  # Optional: Uncomment to filter by sprint
  # additional_jql: 'AND sprint in openSprints()'
  
  # Optional: Uncomment to filter by priority
  # additional_jql: 'AND priority in (High, Highest)'
```

## Affected MCP Tools

The following MCP tools now read from `mcp_query_filters`:

1. **`get_team_issues`** - Uses `default_status`, `order_by`, and `additional_jql`
2. **`dump_jira_team_data`** - Uses `all_statuses`, `order_by`, and `additional_jql`
3. **`generate_jira_team_report`** - Uses `default_status` (via get_team_issues)
4. **`generate_detailed_jira_report`** - Uses `default_status` (via generate_jira_team_report)
5. **`generate_executive_summary`** - Uses `default_status` (via generate_jira_team_report)

## How It Works

### Default Status Filtering

When you call an MCP tool **without** specifying a status:

```python
# Old behavior (hardcoded):
get_team_issues(team="toolchain")  # Always used "In Progress"

# New behavior (configurable):
get_team_issues(team="toolchain")  # Uses mcp_query_filters.default_status
```

You can still override the default by providing a status parameter:

```python
get_team_issues(team="toolchain", status="Done")  # Overrides config default
```

### Additional JQL Filtering

The `additional_jql` setting is automatically appended to all JQL queries generated by MCP tools:

**Example: Filter by Open Sprints**

```yaml
mcp_query_filters:
  additional_jql: 'AND sprint in openSprints()'
```

Generated JQL:
```sql
project = "Automotive Feature Teams" 
AND statusCategory = "In Progress" 
AND "AssignedTeam" = "rhivos-pdr-auto-toolchain" 
AND sprint in openSprints()  -- Added automatically
ORDER BY updated DESC
```

**Example: Filter by Priority**

```yaml
mcp_query_filters:
  additional_jql: 'AND priority in (High, Highest)'
```

### All Statuses Filtering

When using "All" filters in data collection tools:

```python
dump_jira_team_data(team="toolchain", tickets_filter="All In Progress")
```

The tool will use the statuses defined in `all_statuses`:

```yaml
mcp_query_filters:
  all_statuses:
    - "To Do"
    - "In Progress"
    - "In Review"
    - "Blocked"
    - "Code Review"
```

Generated JQL:
```sql
status IN ("To Do", "In Progress", "In Review", "Blocked", "Code Review")
```

### Custom Sort Order

Control how results are sorted:

```yaml
mcp_query_filters:
  order_by: "priority DESC, updated DESC"
```

## Difference from `query_filters`

The config now has **two separate filter sections**:

| Section | Purpose | Used By |
|---------|---------|---------|
| `query_filters` | Email workflow filtering | GitHub Actions, automated reports |
| `mcp_query_filters` | MCP tool defaults | Interactive MCP server tools |

This separation allows:
- **GitHub workflows** to have strict, automated filtering rules
- **MCP tools** to have different defaults for interactive use

## Examples

### Example 1: Only Active Sprint Tickets

```yaml
mcp_query_filters:
  default_status: "In Progress"
  additional_jql: 'AND sprint in openSprints()'
  order_by: "priority DESC, updated DESC"
```

### Example 2: High Priority Only

```yaml
mcp_query_filters:
  default_status: "In Progress"
  additional_jql: 'AND priority in (High, Highest)'
  order_by: "priority DESC"
```

### Example 3: All Statuses, No Additional Filters

```yaml
mcp_query_filters:
  default_status: "In Progress"
  all_statuses:
    - "To Do"
    - "In Progress"
    - "In Review"
    - "Done"
    - "Blocked"
  additional_jql: ''
  order_by: "updated DESC"
```

## Testing Configuration

To test your configuration changes:

1. **Update `config/jira.yaml`** with your desired filters
2. **Restart the MCP server** (if running)
3. **Call an MCP tool** without status parameters:
   ```python
   get_team_issues(team="toolchain")
   ```
4. **Check the returned JQL** in the response to verify filters are applied

## Backward Compatibility

All MCP tools remain backward compatible:

- If `mcp_query_filters` is not defined, tools use hardcoded defaults
- If specific fields are missing, tools fall back to sensible defaults
- User-provided status parameters always override config defaults

## Migration Notes

No changes are required to existing code or integrations. The MCP tools will automatically read from `mcp_query_filters` when available and fall back to previous defaults if the section is missing.

